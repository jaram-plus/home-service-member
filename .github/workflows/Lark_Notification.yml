name: Lark Notification

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, reopened, closed, ready_for_review, review_requested]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, reopened, closed]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. Push ì•Œë¦¼ (ì»¤ë°‹ ì •ë³´ ìƒì„¸)
      - name: Lark Push Notification
        if: github.event_name == 'push'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ”¨ Push to ${{ github.ref_name }}"
          content: |
            **Repository:** ${{ github.repository }}
            **Branch:** `${{ github.ref_name }}`
            **Pusher:** @${{ github.actor }}
            **Commits:** ${{ github.event.commits[0].message }}
            
            ğŸ“Š **Changes:**
            â€¢ ${{ github.event.commits | length }} commit(s)
            â€¢ Files modified: [View Diff](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }})
            
            ğŸ”— **Links:**
            [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) | [View Branch](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})
          header-color: "blue"

      # 2. PR ì˜¤í”ˆ/ì¬ì˜¤í”ˆ ì•Œë¦¼
      - name: Lark PR Opened Notification
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ”€ Pull Request ${{ github.event.action }}"
          content: |
            **${{ github.event.pull_request.title }}** #${{ github.event.pull_request.number }}
            
            ğŸ‘¤ **Author:** @${{ github.event.pull_request.user.login }}
            ğŸŒ¿ **From:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            ğŸ“ **Status:** ${{ github.event.pull_request.draft && 'ğŸ“ Draft' || 'âœ… Ready for Review' }}
            
            **Description:**
            ${{ github.event.pull_request.body || '_No description provided_' }}
            
            ğŸ”— [View Pull Request](${{ github.event.pull_request.html_url }})
          header-color: "purple"

      # 3. PR ë¨¸ì§€/í´ë¡œì¦ˆ ì•Œë¦¼
      - name: Lark PR Closed Notification
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "${{ github.event.pull_request.merged && 'âœ… Pull Request Merged' || 'âŒ Pull Request Closed' }}"
          content: |
            **${{ github.event.pull_request.title }}** #${{ github.event.pull_request.number }}
            
            ğŸ‘¤ **Author:** @${{ github.event.pull_request.user.login }}
            ${{ github.event.pull_request.merged && format('ğŸ”€ **Merged by:** @{0}', github.actor) || format('ğŸš« **Closed by:** @{0}', github.actor) }}
            ğŸŒ¿ **Branch:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            
            ğŸ“Š **Stats:**
            â€¢ Commits: ${{ github.event.pull_request.commits }}
            â€¢ Files changed: ${{ github.event.pull_request.changed_files }}
            â€¢ +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}
            
            ğŸ”— [View Pull Request](${{ github.event.pull_request.html_url }})
          header-color: "${{ github.event.pull_request.merged && 'green' || 'red' }}"

      # 4. PR ë¦¬ë·° ìš”ì²­ ì•Œë¦¼
      - name: Lark PR Review Requested
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ‘€ Review Requested"
          content: |
            **${{ github.event.pull_request.title }}** #${{ github.event.pull_request.number }}
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.requested_reviewer.login }}
            ğŸ“ **Requested by:** @${{ github.actor }}
            
            ğŸ”— [Review Now](${{ github.event.pull_request.html_url }}/files)
          header-color: "orange"

      # 5. PR ë¦¬ë·° ì œì¶œ ì•Œë¦¼
      - name: Lark PR Review Submitted
        if: github.event_name == 'pull_request_review'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "${{ github.event.review.state == 'approved' && 'âœ… Review Approved' || github.event.review.state == 'changes_requested' && 'ğŸ”„ Changes Requested' || 'ğŸ’¬ Review Commented' }}"
          content: |
            **PR:** ${{ github.event.pull_request.title }} #${{ github.event.pull_request.number }}
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.review.user.login }}
            ğŸ“ **Status:** ${{ github.event.review.state }}
            
            **Comment:**
            ${{ github.event.review.body || '_No comment_' }}
            
            ğŸ”— [View Review](${{ github.event.review.html_url }})
          header-color: "${{ github.event.review.state == 'approved' && 'green' || github.event.review.state == 'changes_requested' && 'orange' || 'blue' }}"

      # 6. Issue ì˜¤í”ˆ ì•Œë¦¼
      - name: Lark Issue Opened Notification
        if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "â— Issue ${{ github.event.action }}"
          content: |
            **${{ github.event.issue.title }}** #${{ github.event.issue.number }}
            
            ğŸ‘¤ **Author:** @${{ github.event.issue.user.login }}
            ğŸ·ï¸ **Labels:** ${{ github.event.issue.labels.*.name | join(', ') || 'None' }}
            
            **Description:**
            ${{ github.event.issue.body || '_No description provided_' }}
            
            ğŸ”— [View Issue](${{ github.event.issue.html_url }})
          header-color: "orange"

      # 7. Issue í´ë¡œì¦ˆ ì•Œë¦¼
      - name: Lark Issue Closed Notification
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âœ… Issue Closed"
          content: |
            **${{ github.event.issue.title }}** #${{ github.event.issue.number }}
            
            ğŸ‘¤ **Closed by:** @${{ github.actor }}
            ğŸ·ï¸ **Labels:** ${{ github.event.issue.labels.*.name | join(', ') || 'None' }}
            
            ğŸ”— [View Issue](${{ github.event.issue.html_url }})
          header-color: "green"

      # 8. Issue ëŒ“ê¸€ ì•Œë¦¼
      - name: Lark Issue Comment Notification
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request == null
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ New Comment on Issue"
          content: |
            **Issue:** ${{ github.event.issue.title }} #${{ github.event.issue.number }}
            
            ğŸ‘¤ **Commenter:** @${{ github.event.comment.user.login }}
            
            **Comment:**
            ${{ github.event.comment.body }}
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "green"

      # 9. PR ëŒ“ê¸€ ì•Œë¦¼
      - name: Lark PR Comment Notification
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ New Comment on Pull Request"
          content: |
            **PR:** ${{ github.event.issue.title }} #${{ github.event.issue.number }}
            
            ğŸ‘¤ **Commenter:** @${{ github.event.comment.user.login }}
            
            **Comment:**
            ${{ github.event.comment.body }}
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "purple"

      # 10. PR ë¦¬ë·° ëŒ“ê¸€ ì•Œë¦¼
      - name: Lark PR Review Comment Notification
        if: github.event_name == 'pull_request_review_comment'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ Code Review Comment"
          content: |
            **PR:** ${{ github.event.pull_request.title }} #${{ github.event.pull_request.number }}
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.comment.user.login }}
            ğŸ“ **File:** `${{ github.event.comment.path }}`
            ğŸ“ **Line:** ${{ github.event.comment.line }}
            
            **Comment:**
            ${{ github.event.comment.body }}
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "blue"

      # 11. Workflow ì‹¤íŒ¨ ì•Œë¦¼
      - name: Lark Workflow Failed Notification
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âŒ Workflow Failed"
          content: |
            **Workflow:** ${{ github.event.workflow_run.name }}
            **Repository:** ${{ github.repository }}
            **Branch:** `${{ github.event.workflow_run.head_branch }}`
            
            ğŸ‘¤ **Triggered by:** @${{ github.event.workflow_run.triggering_actor.login }}
            â±ï¸ **Duration:** ${{ github.event.workflow_run.run_duration_ms / 1000 }}s
            
            ğŸ”— [View Workflow Run](${{ github.event.workflow_run.html_url }})
          header-color: "red"

      # 12. Workflow ì„±ê³µ ì•Œë¦¼ (main/develop ë¸Œëœì¹˜ë§Œ)
      - name: Lark Workflow Success Notification
        if: |
          github.event_name == 'workflow_run' && 
          github.event.workflow_run.conclusion == 'success' &&
          (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'develop')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âœ… Workflow Succeeded"
          content: |
            **Workflow:** ${{ github.event.workflow_run.name }}
            **Repository:** ${{ github.repository }}
            **Branch:** `${{ github.event.workflow_run.head_branch }}`
            
            ğŸ‘¤ **Triggered by:** @${{ github.event.workflow_run.triggering_actor.login }}
            â±ï¸ **Duration:** ${{ github.event.workflow_run.run_duration_ms / 1000 }}s
            
            ğŸ”— [View Workflow Run](${{ github.event.workflow_run.html_url }})
          header-color: "green"
