name: Lark Notification

on:
  push:
  pull_request:
    types: [opened, reopened, closed]
  issues:
    types: [opened, reopened, closed]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Push Notification
      - name: Lark Push Notification
        if: github.event_name == 'push'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "blue"
          title: "[${{ github.repository }}:${{ github.ref_name }}] Push Event"
          content: |
            **Push Summary**
            - Repository: `${{ github.repository }}`
            - Branch: `${{ github.ref_name }}`
            - Actor: `${{ github.actor }}`
            - Commits: `${{ github.event.commits.length || 1 }}`

            **Commit Messages**
            • ${{ join(github.event.commits.*.message, '\n• ').substring(0, 500) }}
            ${{ join(github.event.commits.*.message, '\n• ').length > 500 && '...(truncated)' || '' }}

            Links:
            - Compare: ${{ github.event.compare }}
            - Latest Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

      # 2-1. Pull Request Opened / Reopened
      - name: Lark PR Update Notification
        if: >
          github.event_name == 'pull_request' &&
          github.event.action != 'closed'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "purple"
          title: "[PR #${{ github.event.pull_request.number }}] ${{ github.event.pull_request.title }}"
          content: |
            **Pull Request Update**
            - Action: `${{ github.event.action }}`
            - Author: `${{ github.actor }}`
            - Branch: `${{ github.event.pull_request.head.ref }}` → `${{ github.event.pull_request.base.ref }}`
            - State: `${{ github.event.pull_request.state }}`

            **Description**
            ${{ github.event.pull_request.body || 'No description provided.' }}

            Link:
            - PR: ${{ github.event.pull_request.html_url }}

      # 2-2. Pull Request Merged
      - name: Lark PR Merged Notification
        if: >
          github.event_name == 'pull_request' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "green"
          title: "[PR Merged #${{ github.event.pull_request.number }}] ${{ github.event.pull_request.title }}"
          content: |
            **Pull Request Merged**
            - Author: `${{ github.actor }}`
            - Branch: `${{ github.event.pull_request.head.ref }}` → `${{ github.event.pull_request.base.ref }}`
            - Merged At: `${{ github.event.pull_request.merged_at }}`

            Link:
            - PR: ${{ github.event.pull_request.html_url }}

      # 2-3. Pull Request Closed (Not Merged)
      - name: Lark PR Closed Notification
        if: >
          github.event_name == 'pull_request' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == false
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "gray"
          title: "[PR Closed #${{ github.event.pull_request.number }}] ${{ github.event.pull_request.title }}"
          content: |
            **Pull Request Closed**
            - Author: `${{ github.actor }}`
            - Branch: `${{ github.event.pull_request.head.ref }}` → `${{ github.event.pull_request.base.ref }}`

            Link:
            - PR: ${{ github.event.pull_request.html_url }}

      # 3. Issue Notification
      - name: Lark Issue Notification
        if: github.event_name == 'issues'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "orange"
          title: "[Issue #${{ github.event.issue.number }}] ${{ github.event.issue.title }}"
          content: |
            **Issue Update**
            - Action: `${{ github.event.action }}`
            - Reporter: `${{ github.actor }}`
            - State: `${{ github.event.issue.state }}`

            **Description**
            ${{ github.event.issue.body || 'No description provided.' }}

            Link:
            - Issue: ${{ github.event.issue.html_url }}

      # 4. Comment Notification (Issue & PR)
      - name: Lark Comment Notification
        if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          header-color: "green"
          title: "[Comment] #${{ github.event.issue.number || github.event.pull_request.number }}"
          content: |
            **New Comment**
            - Author: `${{ github.actor }}`
            - Target: `${{ github.event.issue.title || github.event.pull_request.title }}`

            **Comment**
            > ${{ github.event.comment.body && github.event.comment.body.substring(0, 500) }}
            ${{ github.event.comment.body && github.event.comment.body.length > 500 && '...(truncated)' || '' }}

            Link:
            - Comment: ${{ github.event.comment.html_url }}
