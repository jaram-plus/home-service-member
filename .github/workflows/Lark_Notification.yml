name: Lark Notification

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, reopened, closed, ready_for_review, review_requested]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, reopened, closed]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. Push ì•Œë¦¼ (ì»¤ë°‹ ì •ë³´ ìƒì„¸)
      - name: Lark Push Notification
        if: github.event_name == 'push'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ”¨ [${{ github.repository }}] Push to ${{ github.ref_name }}"
          content: |
            **Branch:** ${{ github.ref_name }}
            **Pusher:** @${{ github.actor }}
            
            **Latest Commit:**
            ${{ github.event.head_commit.message }}
            
            ğŸ“Š **Changes:**
            â€¢ Multiple commits pushed
            
            ğŸ”— [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) | [View Branch](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})
          header-color: "blue"

      # 2. PR ì˜¤í”ˆ/ì¬ì˜¤í”ˆ ì•Œë¦¼
      - name: Lark PR Opened Notification
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ”€ [${{ github.repository }}] PR #${{ github.event.pull_request.number }} ${{ github.event.action }}"
          content: |
            **${{ github.event.pull_request.title }}**
            
            ğŸ‘¤ **Author:** @${{ github.event.pull_request.user.login }}
            ğŸŒ¿ **From:** ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}
            ğŸ“ **Status:** ${{ github.event.pull_request.draft && 'ğŸ“ Draft' || 'âœ… Ready for Review' }}
            
            **Description:**
            ${{ github.event.pull_request.body || '_No description provided_' }}
            
            ğŸ”— [View Pull Request](${{ github.event.pull_request.html_url }})
          header-color: "purple"

      # 3. PR ë¨¸ì§€/í´ë¡œì¦ˆ ì•Œë¦¼
      - name: Lark PR Closed Notification
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "${{ github.event.pull_request.merged && 'âœ…' || 'âŒ' }} [${{ github.repository }}] PR #${{ github.event.pull_request.number }} ${{ github.event.pull_request.merged && 'Merged' || 'Closed' }}"
          content: |
            **${{ github.event.pull_request.title }}**
            
            ğŸ‘¤ **Author:** @${{ github.event.pull_request.user.login }}
            ${{ github.event.pull_request.merged && format('ğŸ”€ **Merged by:** @{0}', github.actor) || format('ğŸš« **Closed by:** @{0}', github.actor) }}
            ğŸŒ¿ **Branch:** ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}
            
            ğŸ“Š **Stats:**
            â€¢ Commits: ${{ github.event.pull_request.commits }}
            â€¢ Files changed: ${{ github.event.pull_request.changed_files }}
            â€¢ +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}
            
            ğŸ”— [View Pull Request](${{ github.event.pull_request.html_url }})
          header-color: "${{ github.event.pull_request.merged && 'green' || 'red' }}"

      # 4. PR ë¦¬ë·° ìš”ì²­ ì•Œë¦¼
      - name: Lark PR Review Requested
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ‘€ [${{ github.repository }}] Review Requested for PR #${{ github.event.pull_request.number }}"
          content: |
            **${{ github.event.pull_request.title }}**
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.requested_reviewer.login }}
            ğŸ“ **Requested by:** @${{ github.actor }}
            ğŸŒ¿ **Branch:** ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}
            
            ğŸ”— [Review Now](${{ github.event.pull_request.html_url }}/files)
          header-color: "orange"

      # 5. PR ë¦¬ë·° ì œì¶œ ì•Œë¦¼
      - name: Lark PR Review Submitted
        if: github.event_name == 'pull_request_review'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "${{ github.event.review.state == 'approved' && 'âœ… Approved' || github.event.review.state == 'changes_requested' && 'ğŸ”„ Changes Requested' || 'ğŸ’¬ Commented' }} [${{ github.repository }}] PR #${{ github.event.pull_request.number }}"
          content: |
            **${{ github.event.pull_request.title }}**
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.review.user.login }}
            ğŸ“ **Status:** ${{ github.event.review.state }}
            
            **Comment:**
            ${{ github.event.review.body || '_No comment_' }}
            
            ğŸ”— [View Review](${{ github.event.review.html_url }})
          header-color: "${{ github.event.review.state == 'approved' && 'green' || github.event.review.state == 'changes_requested' && 'orange' || 'blue' }}"

      # 6. Issue ì˜¤í”ˆ ì•Œë¦¼
      - name: Lark Issue Opened Notification
        if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "â— [${{ github.repository }}] Issue #${{ github.event.issue.number }} ${{ github.event.action }}"
          content: |
            **${{ github.event.issue.title }}**
            
            ğŸ‘¤ **Author:** @${{ github.event.issue.user.login }}
            ğŸ·ï¸ **Labels:** ${{ join(github.event.issue.labels.*.name, ', ') || 'None' }}
            
            **Description:**
            ${{ github.event.issue.body || '_No description provided_' }}
            
            ğŸ”— [View Issue](${{ github.event.issue.html_url }})
          header-color: "orange"

      # 7. Issue í´ë¡œì¦ˆ ì•Œë¦¼
      - name: Lark Issue Closed Notification
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âœ… [${{ github.repository }}] Issue #${{ github.event.issue.number }} Closed"
          content: |
            **${{ github.event.issue.title }}**
            
            ğŸ‘¤ **Closed by:** @${{ github.actor }}
            ğŸ·ï¸ **Labels:** ${{ join(github.event.issue.labels.*.name, ', ') || 'None' }}
            
            ğŸ”— [View Issue](${{ github.event.issue.html_url }})
          header-color: "green"

      # 8. Issue ëŒ“ê¸€ ì•Œë¦¼ (ëŒ“ê¸€ 10ì¤„ ì œí•œ)
      - name: Prepare Issue Comment
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request == null
        id: issue_comment
        run: |
          COMMENT=$(cat <<'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          TRUNCATED=$(echo "$COMMENT" | head -n 10)
          LINE_COUNT=$(echo "$COMMENT" | wc -l)
          
          if [ "$LINE_COUNT" -gt 10 ]; then
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "... ($(($LINE_COUNT - 10)) more lines)" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          else
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          fi

      - name: Lark Issue Comment Notification
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request == null
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ [${{ github.repository }}] New Comment on Issue #${{ github.event.issue.number }}"
          content: |
            **Issue:** ${{ github.event.issue.title }}
            ğŸ”— [Issue Link](${{ github.event.issue.html_url }})
            
            ğŸ‘¤ **Commenter:** @${{ github.event.comment.user.login }}
            
            **Comment:**
            ```
            ${{ steps.issue_comment.outputs.comment }}
            ```
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "green"

      # 9. PR ëŒ“ê¸€ ì•Œë¦¼ (ì¼ë°˜ ëŒ“ê¸€, 10ì¤„ ì œí•œ)
      - name: Prepare PR Comment
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
        id: pr_comment
        run: |
          COMMENT=$(cat <<'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          TRUNCATED=$(echo "$COMMENT" | head -n 10)
          LINE_COUNT=$(echo "$COMMENT" | wc -l)
          
          if [ "$LINE_COUNT" -gt 10 ]; then
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "... ($(($LINE_COUNT - 10)) more lines)" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          else
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          fi

      - name: Lark PR Comment Notification
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ [${{ github.repository }}] New Comment on PR #${{ github.event.issue.number }}"
          content: |
            **PR:** ${{ github.event.issue.title }}
            ğŸ”— [PR Link](${{ github.event.issue.html_url }})
            
            ğŸ‘¤ **Commenter:** @${{ github.event.comment.user.login }}
            
            **Comment:**
            ```
            ${{ steps.pr_comment.outputs.comment }}
            ```
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "purple"

      # 10. PR ë¦¬ë·° ëŒ“ê¸€ ì•Œë¦¼ (ì½”ë“œ ë¼ì¸ë³„ ëŒ“ê¸€, 10ì¤„ ì œí•œ)
      - name: Prepare PR Review Comment
        if: github.event_name == 'pull_request_review_comment'
        id: review_comment
        run: |
          COMMENT=$(cat <<'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          TRUNCATED=$(echo "$COMMENT" | head -n 10)
          LINE_COUNT=$(echo "$COMMENT" | wc -l)
          
          if [ "$LINE_COUNT" -gt 10 ]; then
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "... ($(($LINE_COUNT - 10)) more lines)" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          else
            echo "comment<<EOFMARKER" >> $GITHUB_OUTPUT
            echo "$TRUNCATED" >> $GITHUB_OUTPUT
            echo "EOFMARKER" >> $GITHUB_OUTPUT
          fi

      - name: Lark PR Review Comment Notification
        if: github.event_name == 'pull_request_review_comment'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "ğŸ’¬ [${{ github.repository }}] Code Review Comment on PR #${{ github.event.pull_request.number }}"
          content: |
            **PR:** ${{ github.event.pull_request.title }}
            ğŸ”— [PR Link](${{ github.event.pull_request.html_url }})
            
            ğŸ‘¤ **Reviewer:** @${{ github.event.comment.user.login }}
            ğŸ“ **File:** ${{ github.event.comment.path }}
            ğŸ“ **Line:** ${{ github.event.comment.line || github.event.comment.original_line }}
            
            **Comment:**
            ```
            ${{ steps.review_comment.outputs.comment }}
            ```
            
            ğŸ”— [View Comment](${{ github.event.comment.html_url }})
          header-color: "blue"

      # 11. Workflow ì‹¤íŒ¨ ì•Œë¦¼
      - name: Lark Workflow Failed Notification
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âŒ [${{ github.repository }}] Workflow Failed: ${{ github.event.workflow_run.name }}"
          content: |
            **Branch:** ${{ github.event.workflow_run.head_branch }}
            
            ğŸ‘¤ **Triggered by:** @${{ github.event.workflow_run.triggering_actor.login }}
            
            ğŸ”— [View Workflow Run](${{ github.event.workflow_run.html_url }})
          header-color: "red"

      # 12. Workflow ì„±ê³µ ì•Œë¦¼ (main/develop ë¸Œëœì¹˜ë§Œ)
      - name: Lark Workflow Success Notification
        if: |
          github.event_name == 'workflow_run' && 
          github.event.workflow_run.conclusion == 'success' &&
          (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'develop')
        uses: Nghi-NV/lark-message-action@v1
        with:
          lark-bot-notify-webhook: ${{ secrets.LARK_WEBHOOK }}
          title: "âœ… [${{ github.repository }}] Workflow Succeeded: ${{ github.event.workflow_run.name }}"
          content: |
            **Branch:** ${{ github.event.workflow_run.head_branch }}
            
            ğŸ‘¤ **Triggered by:** @${{ github.event.workflow_run.triggering_actor.login }}
            
            ğŸ”— [View Workflow Run](${{ github.event.workflow_run.html_url }})
          header-color: "green"
